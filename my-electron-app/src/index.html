<!DOCTYPE html>
<html>
<head>
  <title>DeepSeek 小助手</title>
  <link rel="stylesheet" href="../node_modules/highlight.js/styles/github.css" id="light-code-theme">
  <link rel="stylesheet" href="../node_modules/highlight.js/styles/github-dark.css" id="dark-code-theme">
  <link rel="stylesheet" href="styles/main.css">
  <link rel="stylesheet" href="styles/dark-theme.css">
  <link rel="stylesheet" href="styles/settings-panel.css">
  <link rel="stylesheet" href="styles/chat.css">
</head>
<body>
  <!-- 添加自定义标题栏 -->
  <div class="titlebar">
    <div class="titlebar-text">DeepSeek 小助手</div>
    <div class="titlebar-controls">
      <button class="titlebar-button" id="minimize-button">
        <span class="material-icons">remove</span>
      </button>
      <button class="titlebar-button" id="maximize-button">
        <span class="material-icons">crop_square</span>
      </button>
      <button class="titlebar-button" id="close-button">
        <span class="material-icons">close</span>
      </button>
    </div>
  </div>

  <!-- 主要内容区域包装器 -->
  <div class="main-content">
    <!-- 顶部操作栏 -->
    <div class="top-actions">
      <h1>问问 DeepSeek</h1>
      <div class="right-controls">
        <div class="button-group">
          <button id="toggle-settings" class="action-button secondary">设置</button>
          <button id="clear-button" class="action-button danger" onclick="clearHistory()">清除历史</button>
        </div>
        <div class="theme-switch-wrapper">
          <span class="theme-icon material-icons">light_mode</span>
          <label class="theme-switch">
            <input type="checkbox" id="theme-toggle">
            <span class="slider"></span>
          </label>
          <span class="theme-icon material-icons">dark_mode</span>
        </div>
      </div>
    </div>

    <!-- 设置面板 -->
    <div id="settings-panel" class="settings-panel">
      <div class="settings-content">
        <h2>设置</h2>
        <!-- API Key 部分 -->
        <div class="input-group">
          <label for="api-key">API Key</label>
          <input type="text" id="api-key" placeholder="请输入您的 DeepSeek API Key">
          <div class="button-group">
            <button id="test-button" class="secondary">测试 API Key</button>
            <button id="save-button" class="primary">保存</button>
          </div>
        </div>
        
        <!-- 快捷键部分 -->
        <div class="input-group">
          <label for="shortcut">全局快捷键</label>
          <select id="shortcut">
            <option value="CommandOrControl+Alt+A">Ctrl + Alt + A</option>
            <option value="CommandOrControl+Alt+E">Ctrl + Alt + E</option>
          </select>
        </div>

        <!-- 配置路径部分 -->
        <div class="input-group config-path">
            <label>配置文件路径</label>
            <code id="config-path"></code>
            <div class="button-group">
                <button id="open-path-button" class="secondary">打开文件路径</button>
            </div>
        </div>
      </div>
    </div>

    <div id="chat-history">
      <!-- 聊天记录将在这里显示 -->
    </div>
    <div id="input-area">
      <input type="text" id="user-input" placeholder="在此输入消息...">
      <button id="send-button">发送</button>
      <button id="stop-button">
          <span class="material-icons">stop</span>
          停止回答
      </button>
    </div>
  </div>

  <!-- 添加消息提示元素 -->
  <div id="message" class="message"></div>

  <script>
    const { ipcRenderer, shell } = require('electron');
    const marked = require('marked');
    const hljs = require('highlight.js');
    let apiKey = '';
    let currentShortcut = '';
    let configPath = '';
    let messageHistory = [];
    let controller = null;

    // 接收初始配置
    ipcRenderer.on('init-config', (event, config) => {
      apiKey = config.apiKey;
      currentShortcut = config.shortcut;
      configPath = config.configPath;
    });

    // 配置 marked，添加链接处理
    marked.setOptions({
      highlight: function(code, language) {
        if (language && hljs.getLanguage(language)) {
          try {
            return hljs.highlight(code, { language }).value;
          } catch (err) {
            console.error('代码高亮出错:', err);
          }
        }
        return code;  // 如果没有指定语言或出错，返回原始代码
      },
      langPrefix: 'hljs language-',
      renderer: new marked.Renderer()
    });

    // 重写链接渲染器
    const renderer = new marked.Renderer();
    renderer.link = function(href, title, text) {
      return `<a href="${href}" title="${title || ''}" onclick="event.preventDefault(); shell.openExternal('${href}')">${text}</a>`;
    };
    marked.setOptions({ renderer });

    ipcRenderer.on('update-api-key', (event, key) => {
      apiKey = key;
    });

    document.getElementById('user-input').addEventListener('keydown', function(event) {
      if (event.key === 'Enter') {
        event.preventDefault();
        document.getElementById('send-button').click();
      }
    });

    document.getElementById('send-button').addEventListener('click', async function() {
      const sendButton = document.getElementById('send-button');
      const stopButton = document.getElementById('stop-button');
      const userInput = document.getElementById('user-input').value;

      if (userInput.trim() !== '') {
        if (apiKey.trim() === '') {
          alert('API Key 未设置。');
          return;
        }

        try {
          // 显示停止按钮，禁用发送按钮
          sendButton.disabled = true;
          stopButton.style.display = 'inline-flex';  // 使用 inline-flex 以保持图标和文字的对齐

          // 添加用户消息到历史记录
          messageHistory.push({ role: 'user', content: userInput });

          const chatHistory = document.getElementById('chat-history');
          const userMessage = document.createElement('div');
          userMessage.className = 'user-message';
          userMessage.textContent = `${userInput}`;
          chatHistory.appendChild(userMessage);

          document.getElementById('user-input').value = '';
          chatHistory.scrollTop = chatHistory.scrollHeight;

          controller = new AbortController();  // 创建新的 AbortController
          const response = await fetch('https://api.deepseek.com/chat/completions', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${apiKey}`
            },
            body: JSON.stringify({
              model: 'deepseek-chat',
              messages: [
                { role: 'system', content: '你是一个乐于助人的助手。你的回答要简洁、专业。' },
                ...messageHistory
              ],
              stream: true,
              temperature: 0.7,
              max_tokens: 2000
            }),
            signal: controller.signal  // 添加 signal
          });

          const reader = response.body.getReader();
          const decoder = new TextDecoder('utf-8');
          let aiMessage = document.createElement('div');
          aiMessage.className = 'ai-message';
          aiMessage.innerHTML = '';
          chatHistory.appendChild(aiMessage);
          
          let accumulatedContent = '';

          while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            const chunk = decoder.decode(value, { stream: true });
            const lines = chunk.split('\n').filter(line => line.trim() !== '' && line.trim() !== '[DONE]');
            
            for (const line of lines) {
              if (line.startsWith('data: ')) {
                const json = line.replace('data: ', '');
                try {
                  if (json.trim() === '[DONE]') continue;
                  const jsonObject = JSON.parse(json);
                  const content = jsonObject.choices[0].delta.content || '';
                  accumulatedContent += content;
                  aiMessage.innerHTML = marked.parse(accumulatedContent);
                  chatHistory.scrollTop = chatHistory.scrollHeight;
                } catch (e) {
                  console.error('JSON 解析错误:', e);
                }
              }
            }
          }

          // 将 AI 的完整回答添加到历史记录
          messageHistory.push({ role: 'assistant', content: accumulatedContent });

          // 如果历史记录太长，可以限制长度
          if (messageHistory.length > 10) {
            messageHistory = messageHistory.slice(-10);
          }

        } catch (error) {
          if (error.name === 'AbortError') {
            console.log('请求被中止');
            // 在中止时也添加一条提示信息
            const abortMessage = document.createElement('div');
            abortMessage.className = 'ai-message';
            abortMessage.innerHTML = '<em>回答已停止</em>';
            chatHistory.appendChild(abortMessage);
          } else {
            console.error('调用 DeepSeek API 时出错:', error);
          }
        } finally {
          // 恢复按钮状态
          sendButton.disabled = false;
          stopButton.style.display = 'none';
          controller = null;
        }
      } else {
        alert('请输入消息。');
      }
    });

    // 修改停止按钮的事件处理
    document.getElementById('stop-button').addEventListener('click', function() {
      if (controller) {
        controller.abort();  // 中止请求
        this.style.display = 'none';  // 立即隐藏停止按钮
        document.getElementById('send-button').disabled = false;  // 立即启用发送按钮
      }
    });

    // 添加清除历史记录的功能
    function clearHistory() {
      messageHistory = [];
      document.getElementById('chat-history').innerHTML = '';
    }

    // 添加主题切换功能
    const themeToggle = document.getElementById('theme-toggle');
    
    // 从本地存储加载主题设置
    const currentTheme = localStorage.getItem('theme');
    if (currentTheme === 'dark') {
      document.body.classList.add('dark-mode');
      themeToggle.checked = true;
    }

    // 监听主题切换
    themeToggle.addEventListener('change', function() {
      if (this.checked) {
        document.body.classList.add('dark-mode');
        localStorage.setItem('theme', 'dark');
        ipcRenderer.send('theme-update', true);
      } else {
        document.body.classList.remove('dark-mode');
        localStorage.setItem('theme', 'light');
        ipcRenderer.send('theme-update', false);
      }
      
      // 重新渲染所有代码块以更新高亮样式
      document.querySelectorAll('.ai-message pre code').forEach((block) => {
        hljs.highlightElement(block);
      });
    });

    // 页面加载时确保停止按钮是隐藏的
    window.addEventListener('load', function() {
      document.getElementById('stop-button').style.display = 'none';
    });

    // 页面加载时设置初始主题
    window.addEventListener('load', function() {
      const isDark = localStorage.getItem('theme') === 'dark';
      if (isDark) {
        ipcRenderer.send('theme-update', true);
      }
    });

    // 添加窗口控制按钮的事件处理
    document.getElementById('minimize-button').addEventListener('click', () => {
      ipcRenderer.send('window-control', 'minimize');
    });
    
    document.getElementById('maximize-button').addEventListener('click', () => {
      ipcRenderer.send('window-control', 'maximize');
    });
    
    document.getElementById('close-button').addEventListener('click', () => {
      ipcRenderer.send('window-control', 'close');
    });

    // 设置面板的显示/隐藏
    document.getElementById('toggle-settings').addEventListener('click', function() {
      const settingsPanel = document.getElementById('settings-panel');
      settingsPanel.classList.toggle('show');
      // 加载设置
      document.getElementById('api-key').value = apiKey;
      document.getElementById('shortcut').value = currentShortcut;
      document.getElementById('config-path').textContent = configPath;
    });

    // 点击设置面板外部时关闭面板
    document.addEventListener('click', function(event) {
      const settingsPanel = document.getElementById('settings-panel');
      const toggleButton = document.getElementById('toggle-settings');
      if (!settingsPanel.contains(event.target) && 
          !toggleButton.contains(event.target) && 
          settingsPanel.classList.contains('show')) {
        settingsPanel.classList.remove('show');
      }
    });

    // 保存 API Key
    document.getElementById('save-button').addEventListener('click', function() {
      const newApiKey = document.getElementById('api-key').value;
      if (newApiKey.trim() !== '') {
        apiKey = newApiKey;
        ipcRenderer.send('save-config', { apiKey, shortcut: currentShortcut });
        showMessage('API Key 设置成功！', 'success');
      } else {
        showMessage('请输入有效的 API Key。', 'error');
      }
    });

    // 保存快捷键
    document.getElementById('shortcut').addEventListener('change', function() {
      currentShortcut = this.value;
      ipcRenderer.send('save-config', { apiKey, shortcut: currentShortcut });
      showMessage('快捷键设置成功！', 'success');
    });

    // 打开配置文件路径
    document.getElementById('open-path-button').addEventListener('click', function() {
      if (configPath) {
        shell.showItemInFolder(configPath);
        showMessage('已打开配置文件所在目录', 'success');
      } else {
        showMessage('无法获取配置文件路径', 'error');
      }
    });

    // 添加显示消息的函数
    function showMessage(text, type = 'success') {
      const message = document.getElementById('message');
      message.textContent = text;
      message.className = `message ${type}`;
      
      // 强制重绘
      message.offsetHeight;
      
      message.classList.add('show');
      
      // 3秒后自动隐藏
      setTimeout(() => {
        message.classList.remove('show');
      }, 3000);
    }

    // 添加测试按钮的事件处理
    document.getElementById('test-button').addEventListener('click', async function() {
      const currentApiKey = document.getElementById('api-key').value;
      
      if (currentApiKey.trim() === '') {
        showMessage('请输入 API Key 后再测试', 'error');
        return;
      }
      
      try {
        const response = await fetch('https://api.deepseek.com/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${currentApiKey}`
          },
          body: JSON.stringify({
            model: 'deepseek-chat',
            messages: [{ role: 'system', content: '测试消息' }],
            stream: false,
            max_tokens: 10  // 限制返回的 token 数量，加快测试速度
          })
        });
        
        if (response.ok) {
          const data = await response.json();
          if (data && data.choices && data.choices.length > 0) {
            showMessage('API Key 测试成功！', 'success');
          } else {
            showMessage('API 响应格式异常，请重试。', 'error');
          }
        } else {
          const errorData = await response.json().catch(() => ({}));
          showMessage(errorData.error?.message || 'API Key 无效，请检查后重试。', 'error');
        }
      } catch (error) {
        console.error('测试 API Key 时出错:', error);
        showMessage('测试过程中出现错误，请检查网络连接。', 'error');
      }
    });
  </script>
</body>
</html> 